#!/usr/bin/env bash
set -euo pipefail

SERVER_URL="${SPEC_SLIDES_SERVER:-http://localhost:3000}"
SPECSTORY_DIR="${SPECSTORY_DIR:-.specstory/history}"

usage() {
  echo "Usage: bin/specslides [path/to/specstory.md]"
  echo ""
  echo "Environment:"
  echo "  SPEC_SLIDES_SERVER  Server base URL (default: http://localhost:3000)"
  echo "  SPECSTORY_DIR       Directory of SpecStory markdown files (default: .specstory/history)"
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
  exit 0
fi

FILE_PATH="${1:-}"

if [[ -z "$FILE_PATH" ]]; then
  if [[ ! -d "$SPECSTORY_DIR" ]]; then
    echo "SpecStory history directory not found: $SPECSTORY_DIR" >&2
    exit 1
  fi

  FILE_PATH="$(ls -t "$SPECSTORY_DIR"/*.md 2>/dev/null | head -n 1 || true)"
fi

if [[ -z "$FILE_PATH" || ! -f "$FILE_PATH" ]]; then
  echo "No SpecStory markdown file found." >&2
  exit 1
fi

PAYLOAD="$(python3 - <<PY
import json
import pathlib

path = pathlib.Path("${FILE_PATH}")
markdown = path.read_text()
payload = {
  "story": {
    "markdown": markdown,
    "source": "specstory",
    "source_path": str(path),
  }
}
print(json.dumps(payload))
PY
)"

RESPONSE="$(curl -sS -X POST "${SERVER_URL}/api/stories" \
  -H "Content-Type: application/json" \
  -d "${PAYLOAD}")"

echo "$RESPONSE" | python3 - <<PY
import json
import sys

try:
    data = json.load(sys.stdin)
except json.JSONDecodeError:
    print("Upload failed: invalid JSON response", file=sys.stderr)
    sys.exit(1)

url = data.get("url")
if url:
    print(url)
    sys.exit(0)

error = data.get("error", "upload_failed")
details = data.get("details")
print(f"Upload failed: {error}", file=sys.stderr)
if details:
    print(details, file=sys.stderr)
sys.exit(1)
PY
